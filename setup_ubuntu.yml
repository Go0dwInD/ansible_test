---
- hosts: ubuntu
  become: yes
  gather_facts: false
  tasks:
    - name: Install python
      apt:
        pkg: python3
        state: present
        update_cache: yes

    - name: Installs Ngix
      apt:
        pkg: nginx
        state: present
      notify:
         - Nginx start
         - Nginx startup

    - name: Checking for the existence of the user nginx
      shell: cat /etc/passwd | grep nginx
      register: user_exist_status
      ignore_errors: true

    - name: Create Nginx user
      command: useradd --no-create-home nginx
      when: user_exist_status is failed

    - name: Change default nginx configan
      copy:
         src: ./files/config/nginx.conf
         dest: /etc/nginx/nginx.conf
         owner: root
         mode: 0644

    - name: Add static site
      copy:
          src: ./files/site/index.html
          dest: /var/www/html/index.html
          owner: root
          mode: 0644
      register: site_not_found
      ignore_errors: true

    - name: Setup site config
      template:
          src: ./files/config/site_config.j2
          dest: /etc/nginx/sites-available/{{domain_name}}
          owner: root
          mode: 0644
      when: site_not_found is succeeded

    - name: Setup redirect on google
      template:
          src: ./files/config/redirect_config.j2
          dest: /etc/nginx/sites-available/{{domain_name}}
          owner: root
          mode: 0644
      when: site_not_found is failed
      notify: Nginx reload

    - name: Remove default nginx site config
      file:
         name: /etc/nginx/sites-enabled/default
         state: absent

    - name: Enable site
      file:
         src: /etc/nginx/sites-available/{{domain_name}}
         dest: /etc/nginx/sites-enabled/{{domain_name}}
         state: link
      notify:
         - Nginx reload

  handlers:
    - name: Nginx start
      service:
        name: nginx
        state: started

    - name: Nginx startup
      service:
        name: nginx
        enabled: yes

    - name: Nginx reload
      command: nginx -s reload